(()=>{"use strict";var e={843:function(e,t,s){var r=this&&this.__awaiter||function(e,t,s,r){return new(s||(s=Promise))((function(i,n){function o(e){try{u(r.next(e))}catch(e){n(e)}}function a(e){try{u(r.throw(e))}catch(e){n(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,a)}u((r=r.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.AuthLib=void 0;const n=s(860),o=i(s(344)),a=s(319),u=s(773),d=s(415),h=s(828),l=i(s(38)),c=i(s(231));var f;!function(e){e.REFRESH="refresh",e.ACCESS="access"}(f||(f={}));const v=new d.Schema("tokens",{sub:{type:"string"},hashedToken:{type:"string"},type:{type:"string"},expires_in:{type:"string"}},{dataStructure:"HASH"});var g;!function(e){e.LOGIN="login",e.REGISTER="register",e.LOGOUT="logout",e.USER="user",e.REFRESH="refresh"}(g||(g={}));const p={redisUrl:"",authRoute:"/auth",mapUserToJwtPayload:()=>({sub:""}),jwtConfig:{accessTokenSecret:"",refreshTokenSecret:"",expiresIn:{refresh:"1d",access:"7d"},issuer:"",audience:""}};t.AuthLib=class{constructor(e=p){this.jwtConfig=p.jwtConfig,this.authRoute=p.authRoute,this.router=(0,n.Router)(),this.validateFns={},this.mapUserToJwtPayload=p.mapUserToJwtPayload,this.handleLogin=(e,t,s)=>{this.validateFns[g.LOGIN](e.body,((s,i)=>r(this,void 0,void 0,(function*(){if(i)return t.status(401).json({message:"Login Failed",err:i});e.user=s;const{accessToken:r,refreshToken:n}=yield this.getTokens(s);return t.status(201).json({user:s,accessToken:r,refreshToken:n})}))))},this.handleRegister=(e,t,s)=>{this.validateFns[g.REGISTER](e.body,((s,i)=>r(this,void 0,void 0,(function*(){if(i)return t.status(401).json({message:"Registeration Failed",err:i});e.user=s;const{accessToken:r,refreshToken:n}=yield this.getTokens(s);return t.status(201).json({user:s,accessToken:r,refreshToken:n})}))))},this.handleGetUser=(e,t,s)=>t.status(200).json({user:e.user}),this.init(e)}init({jwtConfig:e,redisUrl:t,authRoute:s,mapUserToJwtPayload:r}){this.jwtConfig=e,this.authRoute=s||this.authRoute,this.mapUserToJwtPayload=r,this.router=(0,n.Router)(),this.redis=(0,u.createClient)({url:t}),this.tokenRepository=new d.Repository(v,this.redis),this.registerRedisEvents(),this.redis.connect()}registerRedisEvents(){var e;this.redis&&(null===(e=this.redis)||void 0===e||e.on("error",(e=>console.log("[Redis Auth Client]:",e))),this.redis.on("connect",(()=>console.log("[Redis Auth Client]:connected to redis successfully "))),this.redis.on("end",(()=>console.log("[Redis Auth Client]:disconnected from redis "))),this.redis.on("reconnecting",(()=>console.log("[Redis Auth Client]:reconnecting to redis "))))}useJwtValidate(e){this.validateFns.jwt=e}useLoginValidate(e){this.validateFns[g.LOGIN]=e}useRegisterValidate(e){this.validateFns[g.REGISTER]=e}getAuthRouter(){return this.registerRoutes(),this.router}authenticateJwt(e=a.Extractor.fromAuthHeaderAsBearerToken()){return(t,s,r)=>{let i=e(t);if(!i)return s.status(200).json({success:!1,message:"Error! Token was not provided."});try{const e=o.default.verify(i,this.jwtConfig.accessTokenSecret,{issuer:this.jwtConfig.issuer,audience:this.jwtConfig.audience});if((null==e?void 0:e.tokenType)!==f.ACCESS)return s.status(401).json({message:"Invalid Token",err:"Invalid Token"});this.validateFns.jwt(e,((e,i)=>{if(i)return s.status(401).json({message:"Unathorized",err:i});t.user=e,r()}))}catch(e){return s.status(403).json({message:null==e?void 0:e.message,err:e})}}}handleRefreshToken(e=a.Extractor.fromAuthHeaderAsBearerToken()){return(t,s,i)=>r(this,void 0,void 0,(function*(){var i,n,a;let u=e(t);if(!u)return s.status(200).json({success:!1,message:"Error! Token was not provided."});try{const e=o.default.verify(u,this.jwtConfig.refreshTokenSecret,{issuer:this.jwtConfig.issuer,audience:this.jwtConfig.audience});if((null==e?void 0:e.tokenType)!==f.REFRESH)return s.status(401).json({message:"Invalid Token",err:"Invalid Token"});if(!(yield null===(i=this.redis)||void 0===i?void 0:i.exists(`tokens:${e.jti}`)))return s.status(401).json({message:"Invalid Token",err:"Invalid Token"});const t=yield null===(n=this.tokenRepository)||void 0===n?void 0:n.fetch(e.jti);if(!(yield l.default.verify((null==t?void 0:t.hashedToken)||"",u)))return s.status(401).json({message:"Invalid Token",err:"Invalid Token"});yield null===(a=this.tokenRepository)||void 0===a?void 0:a.remove(e.jti),this.validateFns.jwt(e,((e,t)=>r(this,void 0,void 0,(function*(){if(t)return s.status(401).json({message:"Unathorized",err:t});const r=yield this.getTokens(e);return s.status(200).json(r)}))))}catch(e){return s.status(403).json({message:null==e?void 0:e.message,err:e})}}))}getTokens(e){var t,s,i,n,a,u;return r(this,void 0,void 0,(function*(){const r=(0,h.v4)(),d=this.mapUserToJwtPayload(e);if(!d.sub)throw new Error("JwtPayload Mapper Must Contain A sub Identifier");const v=o.default.sign(Object.assign({tokenType:f.ACCESS},d),null===(t=this.jwtConfig)||void 0===t?void 0:t.accessTokenSecret,{expiresIn:null===(i=null===(s=this.jwtConfig)||void 0===s?void 0:s.expiresIn)||void 0===i?void 0:i.access,issuer:this.jwtConfig.issuer,audience:this.jwtConfig.audience}),g=o.default.sign(Object.assign({tokenType:f.REFRESH},d),null===(n=this.jwtConfig)||void 0===n?void 0:n.refreshTokenSecret,{expiresIn:this.jwtConfig.expiresIn.refresh,issuer:this.jwtConfig.issuer,audience:this.jwtConfig.audience,jwtid:r}),p=yield l.default.hash(g);return yield null===(a=this.tokenRepository)||void 0===a?void 0:a.save(r,{sub:d.sub,hashedToken:p,type:f.REFRESH,expires_in:this.jwtConfig.expiresIn.refresh}),yield null===(u=this.tokenRepository)||void 0===u?void 0:u.expire(r,(0,c.default)(this.jwtConfig.expiresIn.refresh)),{accessToken:v,refreshToken:g}}))}registerRoutes(){this.router.post(`${this.authRoute}/${g.LOGIN}`,this.handleLogin),this.router.post(`${this.authRoute}/${g.REGISTER}`,this.handleRegister),this.router.get(`${this.authRoute}/${g.USER}`,this.authenticateJwt(),this.handleGetUser),this.router.get(`${this.authRoute}/${g.REFRESH}`,this.handleRefreshToken())}}},319:function(e,t,s){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Extractor=void 0;const i=r(s(310));var n=/(\S+)\s+(\S+)/;const o="authorization";t.Extractor=class{static fromHeader(e){return function(t){var s=null;return t.headers[e]&&(s=t.headers[e]),s}}static fromBody(e){return function(t){var s=null;return t.body&&Object.prototype.hasOwnProperty.call(t.body,e)&&(s=t.body[e]),s}}static fromUrlQueryParameter(e){return function(t){var s=null,r=i.default.parse(t.url,!0);return r.query&&Object.prototype.hasOwnProperty.call(r.query,e)&&(s=r.query[e]),s}}static fromAuthHeaderWithScheme(e){var t=e.toLowerCase();return function(e){var s=null;if(e.headers[o]){var r=function(e){if("string"!=typeof e)return null;var t=e.match(n);return t&&{scheme:t[1],value:t[2]}}(e.headers[o]);r&&t===r.scheme.toLowerCase()&&(s=r.value)}return s}}static fromAuthHeaderAsBearerToken(){return this.fromAuthHeaderWithScheme("bearer")}}},38:e=>{e.exports=require("argon2")},860:e=>{e.exports=require("express")},344:e=>{e.exports=require("jsonwebtoken")},231:e=>{e.exports=require("ms")},773:e=>{e.exports=require("redis")},415:e=>{e.exports=require("redis-om")},828:e=>{e.exports=require("uuid")},310:e=>{e.exports=require("url")}},t={};function s(r){var i=t[r];if(void 0!==i)return i.exports;var n=t[r]={exports:{}};return e[r].call(n.exports,n,n.exports,s),n.exports}(()=>{const e=s(843),t=s(319);e.AuthLib,t.Extractor})()})();